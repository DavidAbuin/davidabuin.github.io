<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dr. Xuesu Xiao's Lab Universe</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f17; --panel:#0f172a; --ink:#e5e7eb; --muted:#9aa4b2;
    --ring: rgba(96,165,250,.35); --rule: rgba(148,163,184,.22);
    --accent:#ef4444; 
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto}
  a{color:#ef4444;text-decoration:none} a:hover{text-decoration:underline}

  header{position:sticky;top:0;z-index:10;
    backdrop-filter:saturate(140%) blur(6px);
    background:linear-gradient(180deg,rgba(11,15,23,.85),rgba(11,15,23,.55));
    border-bottom:1px solid var(--rule);
  }
  .nav{max-width:1100px;margin:0 auto;display:flex;gap:10px;align-items:center;padding:12px 16px}
  .brand{font-weight:700}
  .pill{padding:8px 12px;border-radius:999px;background:#0c1220;border:1px solid var(--rule);color:#cbd5e1;cursor:pointer}
  .spacer{flex:1}

  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:1.6rem;margin:0 0 8px}
  .muted{color:var(--muted)}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--rule);border-radius:16px}

  /* Universe canvas */
  .universe{position:relative;height:640px;border-radius:16px;overflow:hidden}
  #sky{position:absolute;inset:0;
    background:
      radial-gradient(900px 600px at 20% 10%, rgba(239,68,68,.18), rgba(239,68,68,0) 60%),
      radial-gradient(700px 520px at 85% 120%, rgba(96,165,250,.14), rgba(96,165,250,0) 60%);
  }
  .stars{position:absolute;inset:0;opacity:.6;pointer-events:none;
    background-image:
      radial-gradient(1px 1px at 12% 18%, #ffffff 70%, transparent 71%),
      radial-gradient(1px 1px at 22% 46%, #bae6fd 70%, transparent 71%),
      radial-gradient(1px 1px at 31% 78%, #c084fc 70%, transparent 71%),
      radial-gradient(1px 1px at 44% 28%, #fda4af 70%, transparent 71%),
      radial-gradient(1px 1px at 57% 63%, #ffffff 70%, transparent 71%),
      radial-gradient(1px 1px at 69% 12%, #bae6fd 70%, transparent 71%),
      radial-gradient(1px 1px at 81% 41%, #c084fc 70%, transparent 71%),
      radial-gradient(1px 1px at 90% 83%, #fda4af 70%, transparent 71%);
    background-repeat:no-repeat;
  }

  .controls{position:absolute;left:16px;top:16px;display:flex;flex-wrap:wrap;gap:8px;z-index:5}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#0c1220;border:1px solid var(--rule);cursor:pointer;user-select:none}
  .chip input{all:unset;width:14px;height:14px;border-radius:3px;border:1px solid var(--rule);display:inline-block}
  .chip.active{outline:2px solid var(--ring)}

  /* Stage (transform target). Host custom props to counter-scale nodes */
  #stage{position:absolute;inset:0;transform-origin:50% 50%;will-change:transform;--invScale:1;--negRot:0deg}

  /* Nodes: outer .node moves with stage; inner .content counters scale/rotation */
  .node{position:absolute;transform:translate(-50%,-50%)}
  .node .content{display:flex;flex-direction:column;align-items:center;gap:8px;transform:scale(var(--invScale)) rotate(var(--negRot));transform-origin:center}
  .planet{width:88px;height:88px;border-radius:50%;background:linear-gradient(135deg, rgba(239,68,68,.25), rgba(96,165,250,.25));border:2px solid var(--rule);box-shadow:0 0 0 4px rgba(239,68,68,.09),0 6px 20px rgba(0,0,0,.5);display:grid;place-items:center;cursor:pointer;transition:transform .15s ease}
  .planet img{width:78px;height:78px;border-radius:50%;object-fit:cover}
  .node:hover .planet{transform:scale(1.06)}
  .label{font-size:.85rem;color:#d1d5db;text-align:center;max-width:180px}

  /* Links live inside stage so they transform with nodes */
  svg.links{position:absolute;inset:0;pointer-events:none}
  .link{stroke:rgba(148,163,184,.35);stroke-width:1.5}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:40}
  .modal.open{display:flex}
  .sheet{max-width:800px;width:min(92%,800px);background:var(--panel);border:1px solid var(--rule);border-radius:18px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.6)}
  .sheet-header{display:flex;gap:16px;align-items:center;padding:16px;border-bottom:1px solid var(--rule)}
  .sheet-header img{width:64px;height:64px;border-radius:12px;object-fit:cover}
  .sheet-body{padding:16px;color:#cbd5e1}
  .close{margin-left:auto;background:#0b1220;border:1px solid var(--rule);color:#e5e7eb;padding:8px 10px;border-radius:10px;cursor:pointer}
  .tag{display:inline-block;margin:6px 6px 0 0;padding:4px 8px;border-radius:999px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.35);font-size:.78rem}
  .hero{padding:16px}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand">Lab Universe</div>
    <a class="pill" href="index.html">← Back to Home</a>
    <span class="spacer"></span>
    <a class="pill" href="#about">About</a>
  </div>
</header>

<div class="wrap">
  <div class="card hero">
    <h1>Research Universe</h1>
    <div class="muted">Click a planet to view details. Use the chips to filter by role/topic. Pan/zoom/rotate with mouse or buttons. Nodes stay readable; edges follow nodes.</div>
  </div>

  <div class="card universe" id="universe">
    <div id="sky"></div>
    <div class="stars"></div>

    

    <!-- Stage holds BOTH the SVG and the nodes -->
    <div id="stage">
      <svg class="links" viewBox="0 0 1200 640" preserveAspectRatio="none"></svg>
      <!-- nodes injected by JS -->
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal" aria-hidden="true" role="dialog">
  <div class="sheet">
    <div class="sheet-header">
      <img id="m-thumb" alt="">
      <div>
        <div id="m-title" style="font-weight:700"></div>
        <div id="m-sub" class="muted" style="font-size:.9rem"></div>
      </div>
      <button class="close" id="m-close">Close</button>
    </div>
    <div class="sheet-body">
      <div id="m-desc"></div>
      <div id="m-tags" style="margin-top:6px"></div>
      <div id="m-links" style="margin-top:10px"></div>
    </div>
  </div>
</div>



<script>
// ===== DOM refs =====
const wrap    = document.getElementById('universe');
const stage   = document.getElementById('stage');
const linkSvg = stage.querySelector('svg.links');

// ===== Data holder (filled by loadData) =====
let data;

// Load JSON → normalize to {filters, nodes[], links[]}
async function loadData(){
  const res = await fetch('data/lab-data.json', { cache: 'no-store' });
  if(!res.ok) throw new Error('Failed to load data/lab-data.json');
  const raw = await res.json();

  const nodes = Object.values(raw.characters).map(c => ({
    id: c.id,
    title: c.name,
    sub: c.role || '',
    img: c.img,
    x: raw.positions[c.id]?.x ?? 600,
    y: raw.positions[c.id]?.y ?? 320,
    desc: c.desc || '',
    links: c.links || []
  }));

  const links = Object.values(raw.relationship).map(r => [ r.id, r.target_id ]);

  return { nodes, links };
}

// ===== Transform state (pan / zoom) =====
const t     = { x:0, y:0, scale:1 };
const LIMIT = { minScale: 0.4, maxScale: 3 };

function applyTransform(){
  stage.style.transform = `translate(${t.x}px,${t.y}px) scale(${t.scale})`;
  // keep portraits/labels readable if you want: counter-scale inner content
  stage.style.setProperty('--invScale', (1/t.scale).toFixed(3));
  stage.style.setProperty('--negRot', `0deg`); // no rotation in mouse-only mode
}
applyTransform();

// ===== Render nodes & links =====
function renderNodes(){
  // clear previous nodes
  [...stage.querySelectorAll('.node')].forEach(n=>n.remove());

  data.nodes.forEach(n=>{
    const el = document.createElement('div');
    el.className = 'node';
    el.style.left = (n.x/1200*100)+'%';
    el.style.top  = (n.y/640*100)+'%';
    el.innerHTML = `
      <div class="content">
        <div class="planet" data-id="${n.id}"><img alt="${n.title}" src="${n.img}"></div>
        <div class="label">${n.title}</div>
      </div>`;
    el.querySelector('.planet').addEventListener('click', ()=> openModal(n));
    stage.appendChild(el);
  });

  drawLinks();
}

function drawLinks(){
  const W=1200,H=640;
  linkSvg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  linkSvg.innerHTML = '';
  data.links.forEach(([a,b])=>{
    const A = data.nodes.find(n=>n.id===a), B = data.nodes.find(n=>n.id===b);
    if(!A || !B) return;
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.classList.add('link');
    line.setAttribute('x1', A.x); line.setAttribute('y1', A.y);
    line.setAttribute('x2', B.x); line.setAttribute('y2', B.y);
    linkSvg.appendChild(line);
  });
}

// ===== Modal =====
const modal  = document.getElementById('modal');
const mClose = document.getElementById('m-close');

function openModal(n){
  document.getElementById('m-thumb').src = n.img;
  document.getElementById('m-title').textContent = n.title;
  document.getElementById('m-sub').textContent = n.sub || '';
  document.getElementById('m-desc').textContent = n.desc || '';
  document.getElementById('m-tags').innerHTML = ''; // no tags in mouse-only minimal mode
  document.getElementById('m-links').innerHTML = (n.links||[]).map(l=>`<a class="pill" style="margin-right:8px" href="${l.href}" target="_blank" rel="noopener">${l.label}</a>`).join('');
  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
}
mClose.onclick = ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); };
modal.addEventListener('click', (e)=>{ if(e.target===modal) mClose.click(); });

// ===== Mouse interactions =====

// Drag to pan
let dragging=false,lastX=0,lastY=0;
wrap.addEventListener('pointerdown', (e)=>{
  if(e.target.closest('.planet')) return; // clicking a node shouldn't start panning
  dragging=true; wrap.setPointerCapture(e.pointerId);
  lastX=e.clientX; lastY=e.clientY;
});
wrap.addEventListener('pointermove', (e)=>{
  if(!dragging) return;
  const dx=e.clientX-lastX, dy=e.clientY-lastY;
  t.x+=dx; t.y+=dy; lastX=e.clientX; lastY=e.clientY; applyTransform();
});
wrap.addEventListener('pointerup', ()=> dragging=false);
wrap.addEventListener('pointercancel', ()=> dragging=false);

// Cursor-centric zoom (wheel)
wrap.addEventListener('wheel', (e)=>{
  e.preventDefault();
  const rect = stage.getBoundingClientRect();
  const cx = e.clientX - rect.left;
  const cy = e.clientY - rect.top;
  const preX = (cx - t.x) / t.scale;
  const preY = (cy - t.y) / t.scale;
  const factor = (e.deltaY>0)? 0.9 : 1.1;
  const nextScale = Math.max(LIMIT.minScale, Math.min(LIMIT.maxScale, t.scale*factor));
  t.x = cx - preX * nextScale;
  t.y = cy - preY * nextScale;
  t.scale = nextScale;
  applyTransform();
}, {passive:false});

// Double-click background to reset view
wrap.addEventListener('dblclick', (e)=>{
  if(e.target.closest('.planet')) return;
  t.x=0; t.y=0; t.scale=1; applyTransform();
});

// Recompute link positions if container resizes
window.addEventListener('resize', drawLinks);

// ===== Boot =====
loadData()
  .then(d => { data = d; renderNodes(); })
  .catch(err => { console.error(err); alert('Could not load lab data.'); });
</script>



  
  
</script>
</body>
</html>
